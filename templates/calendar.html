{% extends 'layout.html' %}
{% block content %}

<div class="content">
    <h1>Competition Calendar</h1>
    <p class="page-subtitle">Track all your gymnastics competitions</p>

    <!-- Calendar Navigation -->
    <div class="calendar-nav">
        <a href="{{ url_for('main.calendar_view', year=prev_year, month=prev_month) }}" class="nav-btn">
            <span class="nav-icon">←</span> Previous
        </a>
        <div class="current-month">
            <span class="year-number">{{ year }}</span>
            <span class="month-name">{{ month_name }}</span>
        </div>
        <a href="{{ url_for('main.calendar_view', year=next_year, month=next_month) }}" class="nav-btn">
            Next <span class="nav-icon">→</span>
        </a>
    </div>

    <!-- Calendar Controls -->
    <div class="calendar-controls">
        <div class="calendar-filters">
            <div class="filter-group">
                <label class="filter-label">Show:</label>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="draft">Draft</button>
                    <button class="filter-btn" data-filter="live">Live</button>
                    <button class="filter-btn" data-filter="completed">Completed</button>
                </div>
            </div>
            <button class="today-btn" onclick="goToToday()">Current Month</button>
        </div>
    </div><!-- calendar-controls -->

    <div class="calendar-grid">
        <div class="calendar-header">Sun</div>
        <div class="calendar-header">Mon</div>
        <div class="calendar-header">Tue</div>
        <div class="calendar-header">Wed</div>
        <div class="calendar-header">Thu</div>
        <div class="calendar-header">Fri</div>
        <div class="calendar-header">Sat</div>

        {% for week in calendar_data %}
        {% for day in week %}
        {% if day == 0 %}
        <div class="calendar-day other-month"></div>
        {% else %}
        {% set is_today = (day == today.day and month == today.month and year == today.year) %}
        <div class="calendar-day {% if is_today %}today{% endif %}">
            <div class="day-number">{{ day }}</div>

            {% if day in competitions_by_date %}
            {% for competition in competitions_by_date[day] %}
            <div class="competition-tile {{ competition.status }}" data-competition-id="{{ competition.id }}"
                data-status="{{ competition.status }}">
                <div class="competition-header">
                    <div class="competition-title" title="{{ competition.name }}">{{ competition.name }}</div>
                    <div class="status-wrapper">
                        <div class="status-indicator status-{{ competition.status }}"></div>
                        <div class="status-text status-{{ competition.status }}">{{ competition.status }}</div>
                    </div>
                </div>

                <div class="competition-details">
                    {% if competition.started_at %}
                    <div class="detail-item">
                        <span class="detail-icon">TIME</span>
                        <span class="detail-text">{{ competition.started_at.strftime('%H:%M') }}</span>
                    </div>
                    {% endif %}

                    <div class="detail-item location">
                        <span class="detail-icon">LOC</span>
                        <span class="detail-text" title="{{ competition.address }}">{{ competition.address[:20] }}{% if
                            competition.address|length > 20 %}...{% endif %}</span>
                    </div>

                    <div class="detail-item participants">
                        <span class="detail-icon">PART</span>
                        <span class="detail-text">{{ competition.entries|length }} entries</span>
                    </div>
                </div>

                <div class="competition-actions">
                    {% if competition.status == 'draft' %}
                    <button class="quick-action start-btn" onclick="startCompetition({{ competition.id }}, event)"
                        title="Start Competition">
                        Start
                    </button>
                    {% elif competition.status == 'live' %}
                    <button class="quick-action end-btn" onclick="endCompetition({{ competition.id }}, event)"
                        title="End Competition">
                        End
                    </button>
                    {% endif %}
                    <button class="quick-action view-btn" onclick="viewCompetition({{ competition.id }}, event)"
                        title="View Details">
                        View
                    </button>
                </div>
            </div><!-- competition-tile -->
            {% endfor %}
            {% endif %}
        </div><!-- calendar-day -->
        {% endif %}
        {% endfor %}
        {% endfor %}
    </div><!-- calendar-grid -->

    <div class="calendar-legend">
        <div class="legend-header">
            <h3>Competition Status Guide</h3>
            <p>Click on any competition to view details and take actions</p>
        </div>
        <div class="legend-items">
            <div class="legend-item">
                <div class="status-indicator status-draft"></div>
                <div class="legend-text">
                    <strong>Draft</strong>
                    <small>Setup phase - registration open, competition not yet started</small>
                </div>
            </div>
            <div class="legend-item">
                <div class="status-indicator status-live"></div>
                <div class="legend-text">
                    <strong>Live</strong>
                    <small>Currently in progress - scores being entered and updated</small>
                </div>
            </div>
            <div class="legend-item">
                <div class="status-indicator status-ended"></div>
                <div class="legend-text">
                    <strong>Ended</strong>
                    <small>Competition finished - results available for viewing</small>
                </div>
            </div>
        </div>
        <div class="legend-stats">
            <div class="stat-item">
                <span class="stat-number" id="total-competitions">{{ total_competitions }}</span>
                <span class="stat-label">Total Competitions This Month</span>
            </div>
        </div>
    </div><!-- calendar-legend -->
</div><!-- content -->



<div id="competitionModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <div class="modal-body" id="modalBody">
            Loading...
        </div><!-- modal-body -->
    </div><!-- modal-content -->
</div><!-- competitionModal -->

<script>
    // Calendar filtering functionality
    document.addEventListener('DOMContentLoaded', function () {
        // Filter buttons functionality
        const filterBtns = document.querySelectorAll('.filter-btn');
        const competitions = document.querySelectorAll('.competition-tile');

        filterBtns.forEach(btn => {
            btn.addEventListener('click', function () {
                // Update active button
                filterBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                const filter = this.getAttribute('data-filter');

                // Show/hide competitions based on filter
                competitions.forEach(comp => {
                    if (filter === 'all' || comp.getAttribute('data-status') === filter) {
                        comp.style.display = 'block';
                    } else {
                        comp.style.display = 'none';
                    }
                });
            });
        });
    });

    // Quick action functions
    function startCompetition(competitionId, event) {
        event.stopPropagation();
        if (confirm('Start this competition?')) {
            window.location.href = `/admin/competition/${competitionId}/start`;
        }
    }

    function endCompetition(competitionId, event) {
        event.stopPropagation();
        if (confirm('End this competition?')) {
            window.location.href = `/admin/competition/${competitionId}/end`;
        }
    }

    function viewCompetition(competitionId, event) {
        event.stopPropagation();
        // This will use the existing modal functionality
        const competitionTile = event.target.closest('.competition-tile');
        competitionTile.click();
    }

    function goToToday() {
        const today = new Date();
        const year = today.getFullYear();
        const month = today.getMonth() + 1;
        window.location.href = `/calendar?year=${year}&month=${month}`;
    }

    // Function to start competition from modal
    function startCompetition(competitionId) {
        if (confirm('Are you sure you want to start this competition? Once started, participants can begin receiving scores.')) {
            window.location.href = `/admin/competition/${competitionId}/start`;
        }
    }
</script>

{% endblock %}