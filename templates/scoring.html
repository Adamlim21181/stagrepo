{% extends 'layout.html' %}
{% block title %}Scoring{% endblock %}
{% block content %}

<div class="content">

    {% if no_live_competition %}
    <div class="no-live-competition">
        <h2>No Live Competition</h2>
        <p>There is currently no live competition running. Please contact an admin to start a competition.</p>
    </div> <!-- no-live-competition -->
    {% else %}
    <div class="live-competition-header">
        <h2>Scoring for: {{ live_competition.name }}</h2>
        <p>{{ live_competition.address }}</p>
    </div> <!-- live-competition-header -->

    <div class="progress-section">
        <h3>
            Scoring Progress
            {% if overall_progress.is_complete %}
            <span class="completion-badge">Complete</span>
            {% else %}
            <span class="progress-badge">{{ overall_progress.fully_scored }}/{{ overall_progress.total_gymnasts
                }}</span>
            {% endif %}
        </h3>

        <div class="progress-bar-container">
            <div class="progress-bar">
                <div class="progress-fill" style="width: {{ overall_progress.percentage }}%"></div>
            </div> <!-- progress-bar -->
            <span class="progress-text">{{ "%.0f"|format(overall_progress.percentage) }}% Complete</span>
        </div> <!-- progress-bar-container -->

        {% if overall_progress.is_complete %}
        <div class="completion-message">
            ðŸŽ‰ All {{ overall_progress.total_gymnasts }} gymnasts have been fully scored!
        </div> <!-- completion-message -->
        {% endif %}
    </div> <!-- progress-section -->

    <div class="scoring-form">
        <h3>Score Entry</h3>
        <form method="POST" id="scoring-form">
            {{ form.hidden_tag() }}

            <div class="form-row">
                <div class="form-group">
                    {{ form.entry_id.label(class="form-label") }}
                    {{ form.entry_id(class="form-control", id="entry_id") }}
                    {% if form.entry_id.errors %}
                    <div class="text-danger">
                        {% for error in form.entry_id.errors %}
                        <small>{{ error }}</small>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <div class="form-group">
                    {{ form.apparatus_id.label(class="form-label") }}
                    {{ form.apparatus_id(class="form-control", id="apparatus_id") }}
                    {% if form.apparatus_id.errors %}
                    <div class="text-danger">
                        {% for error in form.apparatus_id.errors %}
                        <small>{{ error }}</small>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="execution-scores-section">
                <div class="section-header">
                    <label>Execution Scores:</label>
                    <button type="button" id="add-judge-btn" class="btn btn-add">+ Add Judge</button>
                </div>

                <div id="execution-scores-container">
                    <!-- First execution score (always present) -->
                    <div class="execution-score-row" data-judge="1">
                        <div class="judge-label">Judge 1:</div>
                        <input type="number" name="execution_scores" step="0.001" min="0" max="10" placeholder="8.5"
                            required class="execution-input">
                        <button type="button" class="remove-judge-btn" style="display: none;">Ã—</button>
                    </div>
                </div>

                <div class="average-display" id="average-display" style="display: none;">
                    <strong>Average E-Score: <span id="average-value">0.000</span></strong>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    {{ form.d_score.label(class="form-label") }}
                    {{ form.d_score(class="form-control", id="d_score", placeholder="6.0") }}
                    {% if form.d_score.errors %}
                    <div class="text-danger">
                        {% for error in form.d_score.errors %}
                        <small>{{ error }}</small>
                        {% endfor %}
                    </div>
                    {% endif %}
                    <small class="form-help">Difficulty score (0-10)</small>
                </div>

                <div class="form-group">
                    {{ form.penalty.label(class="form-label") }}
                    {{ form.penalty(class="form-control", id="penalty", placeholder="0.0") }}
                    {% if form.penalty.errors %}
                    <div class="text-danger">
                        {% for error in form.penalty.errors %}
                        <small>{{ error }}</small>
                        {% endfor %}
                    </div>
                    {% endif %}
                    <small class="form-help">Penalty deductions (optional)</small>
                </div>
            </div>

            <div class="form-group">
                <button type="submit" class="btn btn-primary">Submit Score</button>
            </div>
        </form>
    </div>

    <div class="existing-scores">
        <h3>Recent Scores</h3>
        <table>
            <thead>
                <tr>
                    <th>Status</th>
                    <th>Gymnast ID</th>
                    <th>Gymnast</th>
                    <th>Level</th>
                    <th>Apparatus</th>
                    <th>Judge Scores</th>
                    <th>E Score (Avg)</th>
                    <th>D Score</th>
                    <th>Penalty</th>
                    <th>Total</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for entry, gymnast, club in entries %}
                {% for score in entry.scores %}
                <tr class="{% if scoring_progress[entry.id].is_complete %}complete-row{% endif %}">
                    <td>
                        {% if scoring_progress[entry.id].is_complete %}
                        <span class="status-complete"></span>
                        {% else %}
                        <span class="status-progress">{{ scoring_progress[entry.id].scored_count }}/{{
                            scoring_progress[entry.id].total_count }}</span>
                        {% endif %}
                    </td>
                    <td>#{{ "%03d"|format(gymnast.id) }}</td>
                    <td>{{ gymnast.name }}</td>
                    <td>{{ gymnast.level }}</td>
                    <td>{{ score.apparatus.name }}</td>
                    <td class="judge-scores">
                        {% if score.judge_scores %}
                        {% for judge_score in score.judge_scores %}
                        <span class="judge-score">J{{ judge_score.judge_number }}: {{ "%.3f"|format(judge_score.e_score)
                            }}</span>
                        {% endfor %}
                        {% else %}
                        <span class="no-judge-scores">No judge scores</span>
                        {% endif %}
                    </td>
                    <td>{{ "%.3f"|format(score.e_score) }}</td>
                    <td>{{ "%.3f"|format(score.d_score) }}</td>
                    <td>{{ "%.3f"|format(score.penalty) }}</td>
                    <td><strong>{{ "%.3f"|format(score.total) }}</strong></td>
                    <td class="actions">
                        <form method="POST" action="{{ url_for('main.delete_score', score_id=score.id) }}"
                            style="display:inline" onsubmit="return confirm('Delete this score?');">
                            {% if csrf_token %}{{ csrf_token() }}{% endif %}
                            <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                        </form>

                    </td>
                </tr>
                {% endfor %}
                {% endfor %}
            </tbody>
        </table>
    </div> <!-- current-scores -->
    {% endif %}

</div> <!-- content -->

{% endblock %}