{% extends 'layout.html' %}
{% block title %}Live Leaderboard{% endblock %}
{% block content %}

<div class="content live-page">

    {% if no_live_competition %}
    <div id="nolive" class="no-live-competition">
        <h2>No Live Competition</h2>
        <p>There is currently no live competition running. Please contact an admin to start a competition.</p>
    </div><!-- no-live-competition -->
    {% else %}

    <div class="sidebar live-sidebar">
        <form method="get">
            {% for level in levels %}
            <button name="level" value="{{ level }}" class="level-btn {{ 'active' if level == selected_level else '' }}" aria-pressed="{{ 'true' if level == selected_level else 'false' }}">
                <span class="level-full">{{ level }}</span>
                <span class="level-short">
                    {% set lname = level|lower %}
                    {% if 'senior' in lname or 'international' in lname %}SI
                    {% elif 'level' in lname %}{{ level|replace('Level','')|trim }}
                    {% else %}{{ level[:2] | upper }}{% endif %}
                </span>
            </button>
            {% endfor %}
        </form>
    </div><!-- sidebar -->

    <div class="main">

        {% if selected_level %}
        <div class="apparatus-bar live-apparatus-bar" role="tablist">
            <form method="get">
                <input type="hidden" name="level" value="{{ selected_level }}">

                <button name="apparatus" value="all_around"
                    class="apparatus-btn {{ 'active' if selected_apparatus_id == 'all_around' or not selected_apparatus_id }}"
                    aria-pressed="{{ 'true' if selected_apparatus_id == 'all_around' or not selected_apparatus_id else 'false' }}">
                    <span class="app-full">All Around</span>
                    <span class="app-short">AA</span>
                </button>

                {% for app in apparatus_list %}
                <button name="apparatus" value="{{ app.id }}"
                    class="apparatus-btn {{ 'active' if app.id|string == selected_apparatus_id }}"
                    aria-pressed="{{ 'true' if app.id|string == selected_apparatus_id else 'false' }}">
                    <span class="app-full">{{ app.name }}</span>
                    <span class="app-short">
                        {% set n = app.name.lower() %}
                        {% if 'floor' in n %}FX
                        {% elif 'pommel' in n %}PH
                        {% elif 'rings' in n %}SR
                        {% elif 'vault' in n %}VT
                        {% elif 'parallel' in n %}PB
                        {% elif 'high bar' in n or 'highbar' in n or 'hbar' in n %}HB
                        {% else %}{{ app.name[:2] | upper }}{% endif %}
                    </span>
                </button>
                {% endfor %}
            </form>
        </div><!-- apparatus-bar -->
        {% endif %}

        {% if leaderboard_data %}
        <div class="table-responsive live-table">
            <table id="leaderboard-table" aria-live="polite">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Gymnast</th>
                    <th>Club</th>
                    <th>E-Score</th>
                    <th>D-Score</th>
                    <th>Penalty</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                {% if selected_apparatus_id and selected_apparatus_id != 'all_around' %}
                <!-- Individual apparatus scores -->
                {% for score, gymnast, club in leaderboard_data %}
                <tr class="leaderboard-row" tabindex="0"
                    data-gymnast-name="{{ gymnast.name }}"
                    data-gymnast-id="{{ gymnast.id }}"
                    data-e-score="{{ "%.3f"|format(score.e_score) }}"
                    data-d-score="{{ "%.3f"|format(score.d_score) }}"
                    data-penalty="{{ "%.3f"|format(score.penalty) }}"
                    data-total="{{ "%.3f"|format(score.total) }}">
                    <td>{{ loop.index }}</td>
                    <td>{{ gymnast.name }}</td>
                    <td>{{ club.name }}</td>
                    <td>{{ "%.3f"|format(score.e_score) }}</td>
                    <td>{{ "%.3f"|format(score.d_score) }}</td>
                    <td>{{ "%.3f"|format(score.penalty) }}</td>
                    <td>{{ "%.3f"|format(score.total) }}</td>
                </tr>
                {% endfor %}
                {% else %}
                <!-- All around scores (total scores) -->
                {% for gymnast_data in leaderboard_data %}
                <tr class="leaderboard-row" tabindex="0"
                    data-gymnast-name="{{ gymnast_data.name }}"
                    data-gymnast-id="{{ gymnast_data.id }}"
                    data-e-score="{{ "%.3f"|format(gymnast_data.total_e_score) }}"
                    data-d-score="{{ "%.3f"|format(gymnast_data.total_d_score) }}"
                    data-penalty="{{ "%.3f"|format(gymnast_data.total_penalty) }}"
                    data-total="{{ "%.3f"|format(gymnast_data.total_score) }}">
                    <td>{{ loop.index }}</td>
                    <td>{{ gymnast_data.name }}</td>
                    <td>{{ gymnast_data.club_name }}</td>
                    <td>{{ "%.3f"|format(gymnast_data.total_e_score) }}</td>
                    <td>{{ "%.3f"|format(gymnast_data.total_d_score) }}</td>
                    <td>{{ "%.3f"|format(gymnast_data.total_penalty) }}</td>
                    <td>{{ "%.3f"|format(gymnast_data.total_score) }}</td>
                </tr>
                {% endfor %}
                {% endif %}
            </tbody>
        </table>
        </div>
        {% elif selected_level %}
        <p>No scores found for that level{% if selected_apparatus_id and selected_apparatus_id != 'all_around' %} and
            apparatus{% endif %}.</p>
        {% else %}
        <p>Please select a level to view the leaderboard.</p>
        {% endif %}

    </div>
    {% endif %}
</div>

<!-- Score Details Modal -->
<div class="modal-overlay" id="scoreModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-gymnast-name" id="modalGymnastName"></h2>
            <button class="modal-close-btn" onclick="closeScoreModal()">&times;</button>
        </div>

        <div class="score-details">
            <div class="score-item">
                <div class="score-label">E-Score</div>
                <div class="score-value" id="modalEScore">0.000</div>
            </div>
            <div class="score-item">
                <div class="score-label">D-Score</div>
                <div class="score-value" id="modalDScore">0.000</div>
            </div>
            <div class="score-item">
                <div class="score-label">Penalty</div>
                <div class="score-value" id="modalPenalty">0.000</div>
            </div>
            <div class="score-item">
                <div class="score-label">Total Score</div>
                <div class="score-value total-score-value" id="modalTotal">0.000</div>
            </div>
        </div>

        <div class="modal-footer">
            <a class="view-bio-link" id="modalBioLink" href="#">View Gymnast Profile</a>
        </div>
    </div>
</div>

<script>
function closeScoreModal() {
    var modal = document.getElementById('scoreModal');
    if (modal) {
        modal.classList.remove('active');
    }
}

function openModal(row) {
    const modal = document.getElementById('scoreModal');
    const gymnastId = row.dataset.gymnastId;
    const gymnastName = row.dataset.gymnastName;
    const eScore = row.dataset.eScore;
    const dScore = row.dataset.dScore;
    const penalty = row.dataset.penalty;
    const total = row.dataset.total;

    document.getElementById('modalGymnastName').textContent = gymnastName;
    document.getElementById('modalEScore').textContent = eScore;
    document.getElementById('modalDScore').textContent = dScore;
    document.getElementById('modalPenalty').textContent = penalty;
    document.getElementById('modalTotal').textContent = total;
    document.getElementById('modalBioLink').href = `/gymnast/${gymnastId}`;

    modal.classList.add('active');
}

// Close modal when clicking overlay
document.getElementById('scoreModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeScoreModal();
    }
});

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeScoreModal();
    }
});

// Open modal on row click
document.querySelectorAll('.leaderboard-row').forEach(row => {
    row.addEventListener('click', function() {
        openModal(this);
    });
});
</script>

{% endblock %}